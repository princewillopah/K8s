# apiVersion: batch/v1
# kind: Job
# metadata:
#   name: db-seed
#   namespace: shopsohere
# spec:
#   backoffLimit: 3
#   template:
#     spec:
#       restartPolicy: OnFailure
#       containers:
#         - name: seed
#           image: princewillopah2/shopsohere-backend:1.0
#           command: ["npm", "run", "seed"]
#           env:
#             - name: MONGO_URI
#               value: mongodb://admin:admin12345@mongo.shopsohere.svc.cluster.local:27017/shopsphereDB?authSource=admin
#             - name: JWT_SECRET
#               value: your_strong_secret_key_here
#             - name: NODE_ENV
#               value: production



# apiVersion: batch/v1
# kind: Job
# metadata:
#   name: db-seed
#   namespace: shopsohere
# spec:
#   backoffLimit: 5
#   template:
#     spec:
#       restartPolicy: OnFailure
#       initContainers:
#         - name: wait-for-mongo
#           image: mongo:6.0
#           command: ["/bin/sh", "-c"]
#           args:
#             - |
#               echo "Waiting for MongoDB to be ready..."
#               # Wait for TCP connection first
#               until nc -z mongo.shopsohere.svc.cluster.local 27017; do
#                 echo "Waiting for MongoDB TCP connection..."
#                 sleep 5
#               done
#               echo "MongoDB TCP connection established"
              
#               # Then wait for authentication to work
#               until mongosh --host mongo.shopsohere.svc.cluster.local \
#                 -u admin \
#                 -p admin12345 \
#                 --authenticationDatabase admin \
#                 --eval "db.adminCommand('ping')" 2>/dev/null; do
#                 echo "Waiting for MongoDB authentication..."
#                 sleep 5
#               done
#               echo "MongoDB is ready and accepting authenticated connections!"
#       containers:
#         - name: seed
#           image: princewillopah2/shopsohere-backend:1.0
#           command: ["/bin/sh", "-c"]
#           args:
#             - |
#               echo "Starting seed script..."
#               echo "MONGO_URI: mongodb://admin:admin12345@mongo.shopsohere.svc.cluster.local:27017/shopsphereDB?authSource=admin"
              
#               # Wait a bit more to ensure MongoDB is fully ready
#               sleep 10
              
#               # Run the seed command
#               npm run seed
#           env:
#             - name: MONGO_URI
#               value: "mongodb://admin:admin12345@mongo.shopsohere.svc.cluster.local:27017/shopsphereDB?authSource=admin"
#             - name: JWT_SECRET
#               value: "your_strong_secret_key_here_change_me"
#             - name: NODE_ENV
#               value: "production"
#             - name: PORT
#               value: "3000"


apiVersion: batch/v1
kind: Job
metadata:
  name: db-seed
  namespace: shopsohere
spec:
  backoffLimit: 3
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: seed
          image: princewillopah2/shopsohere-backend:3.0
          command: ["/bin/sh", "-c"]
          args:
            - |
              echo "Testing MongoDB connection first..."
              
              # Wait a bit for any potential startup
              sleep 10
              
              # Run the seed command
              echo "Starting seed script..."
              npm run seed
          env:
            - name: MONGO_URI
              value: "mongodb://admin:admin12345@mongo.shopsohere.svc.cluster.local:27017/shopsphereDB?authSource=admin"
            - name: JWT_SECRET
              value: "your_strong_secret_key_here_change_me"
            - name: NODE_ENV
              value: "production"
            - name: PORT
              value: "3000"